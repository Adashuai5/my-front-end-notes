éšç€ ajax çš„æµè¡Œï¼Œå¼‚æ­¥æ•°æ®è¯·æ±‚ä½“éªŒæå…·æå‡ï¼Œç”¨æˆ·å¾—ä»¥åœ¨ä¸åˆ·æ–°æµè§ˆå™¨çš„æƒ…å†µä¸‹è¿›è¡Œé¡µé¢äº¤äº’ï¼Œè€Œå¼‚æ­¥äº¤äº’ä½“éªŒçš„æ›´é«˜çº§ç‰ˆæœ¬å°±æ˜¯ SPA â€”â€” å•é¡µåº”ç”¨ã€‚

å•é¡µåº”ç”¨ä¸ä»…ä»…æ˜¯åœ¨é¡µé¢äº¤äº’æ—¶æ— åˆ·æ–°ï¼Œè¿é¡µé¢è·³è½¬éƒ½æ˜¯æ— åˆ·æ–°çš„ï¼Œä¸ºäº†å®ç°å•é¡µåº”ç”¨ï¼Œå°±æœ‰äº†**å‰ç«¯è·¯ç”±**ã€‚

# å¸¸ç”¨çš„ä¸¤ç§æ¨¡å¼

ç±»ä¼¼äºæœåŠ¡ç«¯è·¯ç”±è§£æå¯¹åº”çš„ url è·¯å¾„ï¼Œè¿”å›å¯¹åº”çš„é¡µé¢/èµ„æºçš„æ–¹å¼ï¼Œå‰ç«¯è·¯ç”±å®ç°èµ·æ¥å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯åŒ¹é…ä¸åŒçš„ url è·¯å¾„ï¼Œè¿›è¡Œè§£æï¼Œç„¶ååŠ¨æ€çš„æ¸²æŸ“å‡ºåŒºåŸŸ html å†…å®¹ã€‚

è¿™æ ·è‡ªç„¶ url æ¯æ¬¡å˜åŒ–çš„æ—¶å€™ï¼Œéƒ½ä¼šé€ æˆé¡µé¢çš„åˆ·æ–°ã€‚

é‚£ä¹ˆåœ¨æ”¹å˜ url çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•ä¿è¯é¡µé¢çš„ä¸åˆ·æ–°ï¼Ÿ

## hash æ¨¡å¼

åœ¨ 2014 å¹´ä¹‹å‰ï¼Œå¤§å®¶æ˜¯é€šè¿‡ hash æ¥å®ç°è·¯ç”±ï¼Œurl hash å°±æ˜¯ç±»ä¼¼äºï¼š

```html
https://www.xxx.com/#/login
```

è¿™ç§ # åé¢ hash å€¼çš„å˜åŒ–ï¼Œå¹¶ä¸ä¼šå¯¼è‡´æµè§ˆå™¨å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œæµè§ˆå™¨ä¸å‘å‡ºè¯·æ±‚ï¼Œä¹Ÿå°±ä¸ä¼šåˆ·æ–°é¡µé¢ã€‚

### ä¸ºä»€ä¹ˆæ”¹å˜ hash ä¸åˆ·æ–°é¡µé¢ï¼Ÿâ€”â€”[URLçš„äº•å·â€˜#â€™](http://www.ruanyifeng.com/blog/2011/03/url_hash.html)

>â€˜#â€™ ä»£è¡¨ç½‘é¡µä¸­çš„ä¸€ä¸ªä½ç½®ï¼Œå®ƒåé¢çš„å­—ç¬¦ï¼Œå°±æ˜¯è¯¥ä½ç½®çš„æ ‡è¯†ç¬¦ï¼Œå®ƒåªå¯¹æµè§ˆå™¨æœ‰ç”¨ï¼ŒæœåŠ¡å™¨ä¸è¯†åˆ«ï¼Œå› æ­¤ HTTP è¯·æ±‚ä¸ä¼šåŒ…å« #

(æƒ³è¦è¯·æ±‚ url åŒ…å« # ï¼Œå¯ä½¿ç”¨ [encodeURIComponent()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent)
è¿›è¡Œéƒ¨åˆ†è½¬ä¹‰)

**æ”¹å˜ hash ï¼Œåªä¼šè®©æµè§ˆå™¨æ»šåŠ¨åˆ°ç›¸åº”ä½ç½®ï¼Œä¸ä¼šé‡è½½ç½‘é¡µ**

æ¯æ¬¡ hash å€¼çš„å˜åŒ–ï¼Œä¼šè§¦å‘ hashchange äº‹ä»¶ï¼Œé€šè¿‡[`window.onhashchange`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/onhashchange)ç›‘å¬è¯¥äº‹ä»¶æˆ‘ä»¬å°±å¯ä»¥æ£€æµ‹å˜åŒ–çš„ hash å€¼æ¥åšç›¸åº”çš„é¡µé¢æ“ä½œã€‚

### ç®€æ˜“å®ç°

æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨æœ€ç®€å•çš„ä»£ç å®ç° hash æ¨¡å¼ï¼Œä»…ä¸ºäº†è§£å…¶æ€æƒ³ï¼ˆä½ å¯ä»¥ç›´æ¥å¤åˆ¶åˆ°ä¸€ä¸ª html ä¸Šå¹¶é€šè¿‡é™æ€æœåŠ¡å™¨å¦‚ [http-server](https://www.npmjs.com/package/http-server) æŸ¥çœ‹ï¼‰ï¼š
```
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Hash è·¯ç”±</title>
  </head>
  <body>
    <ul>
      <li><a href="#red">çº¢è‰²èƒŒæ™¯</a></li>
      <li><a href="#green">ç»¿è‰²èƒŒæ™¯</a></li>
      <li><a href="#grey">ç°è‰²èƒŒæ™¯</a></li>
    </ul>
    <script>
      function watchHash() {
        const hash = window.location.hash.slice(1) || '/';
        switch (hash) {
          case "red":
            document.body.style.background = "red";
            break;
          case "green":
            document.body.style.background = "green";
            break;
          case "grey":
            document.body.style.background = "grey";
            break;
        }
      }
      window.addEventListener("hashchange", watchHash, false);
      window.addEventListener("load", watchHash, false);
    </script>
  </body>
</html>
```

#### å¦‚ä½•å®ç°æœ€åŸºç¡€çš„å‰è¿›åé€€ï¼Ÿ

è¿™é‡Œæˆ‘ä»¬ç®€å•å®ç°ä¸€ä¸‹åé€€åŠŸèƒ½ï¼Œå‰è¿›æ€è·¯ç±»ä¼¼ï¼š

```
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Hash è·¯ç”±</title>
  </head>
  <body>
    <ul>
      <li><a href="#red">çº¢è‰²èƒŒæ™¯</a></li>
      <li><a href="#green">ç»¿è‰²èƒŒæ™¯</a></li>
      <li><a href="#grey">ç°è‰²èƒŒæ™¯</a></li>
    </ul>
    <button id="back" disabled="true">åé€€</button>
    <script>
      var isGoBack = false;
      const history = [];
      function watchHash() {
        const hash = window.location.hash.slice(1) || "/";
        // é˜²æ­¢åé€€æ—¶ä¹Ÿè®°å½• hash
        if (!isGoBack && window.location.hash) {
          history.push(window.location.hash);
        }
        back.disabled = history.length > 0 ? false : true;
        console.log(history);
        switch (hash) {
          case "red":
            document.body.style.background = "red";
            break;
          case "green":
            document.body.style.background = "green";
            break;
          case "grey":
            document.body.style.background = "grey";
            break;
          default:
            document.body.style.background = "#fff";
        }
        isGoBack = false;
      }
      back.onclick = goBack;
      function goBack() {
        isGoBack = true;
        if (history.length > 0) {
          history.pop(1);
          window.location.hash = history[history.length - 1] || "";
        } else {
          back.disabled = true;
        }
      }
      window.addEventListener("load", watchHash, false);
      window.addEventListener("hashchange", watchHash, false);
    </script>
  </body>
</html>
```

æ€è·¯å°±æ˜¯é€šè¿‡ä¸€ä¸ªæ•°ç»„è®°å½•æ¯æ¬¡ hashchange äº‹ä»¶çš„ hash å€¼ï¼Œç‚¹å‡»åé€€æ—¶å–å‡ºä¸Šä¸€æ¬¡ hash å€¼è¦†ç›–å½“å‰é¡µé¢çš„ hashã€‚

éœ€è¦æ³¨æ„çš„æ˜¯éœ€è¦åŒºåˆ«å½“å‰ hash æ˜¯åé€€ç”Ÿæˆï¼ˆåé€€æ—¶çš„ hash å˜åŒ–ä¸åº”è®°å½•ï¼‰çš„è¿˜æ˜¯è·³è½¬ç”Ÿæˆï¼Œé¿å…é‡å¤è®°å½•ã€‚

![image](https://upload-images.jianshu.io/upload_images/7094266-a0a5b8004805e7da.gif?imageMogr2/auto-orient/strip)

## history æ¨¡å¼

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ—©æœŸ hash æ¨¡å¼è™½ç„¶å¯ä»¥å®ç°å‰ç«¯è·¯ç”±ï¼Œä½†å…¶åé€€å‰è¿›æ“ä½œå°±ååˆ†éº»çƒ¦ã€‚

2014 å¹´åï¼ŒHTML5 å¼•å…¥äº† [History](https://developer.mozilla.org/zh-CN/docs/Web/API/History) APIï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿå¿«é€Ÿè®¿é—®é¡µé¢å†å²ã€‚

å…¶ä¸­Â [history.pushState()](https://developer.mozilla.org/en-US/docs/Web/API/History/pushState)Â å’ŒÂ [history.replaceState()](https://developer.mozilla.org/en-US/docs/Web/API/History/replaceState) æ–¹æ³•ï¼Œå®ƒä»¬åˆ†åˆ«å¯ä»¥æ·»åŠ å’Œä¿®æ”¹å†å²è®°å½•æ¡ç›®ï¼Œé€šè¿‡è¿™ä¸¤ä¸ª API å¯ä»¥æ”¹å˜ url åœ°å€è€Œæ— é¡»é‡æ–°åŠ è½½é¡µé¢ã€‚

åŒæ—¶è¿˜æœ‰ popstate äº‹ä»¶ï¼š
é€šè¿‡[`window.onpopstate`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/onpopstate "window.onpopstateæ˜¯popstateäº‹ä»¶åœ¨windowå¯¹è±¡ä¸Šçš„äº‹ä»¶å¤„ç†ç¨‹åº.")å¯ä»¥ç›‘å¬åœ¨**æµè§ˆå™¨ç‚¹å‡»åé€€ã€å‰è¿›æŒ‰é’®(æˆ–è€…åœ¨ JavaScript ä¸­è°ƒç”¨ history.back()ã€history.forward()ã€history.go() æ–¹æ³•)** è§¦å‘çš„ popstate äº‹ä»¶ã€‚

é€šè¿‡è¿™äº›å°±èƒ½ç”¨å¦ä¸€ç§æ–¹å¼æ¥å®ç°å‰ç«¯è·¯ç”±äº†ï¼Œä½†åŸç†éƒ½æ˜¯è·Ÿ hash å®ç°ç›¸åŒçš„ã€‚

### ç”¨ history å®ç°ä¸Šé¢ hash ä»£ç 

```
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>History è·¯ç”±</title>
  </head>
  <body>
    <ul id="ul">
      <li><a href="/red">çº¢è‰²èƒŒæ™¯</a></li>
      <li><a href="/green">ç»¿è‰²èƒŒæ™¯</a></li>
      <li><a href="/grey">ç°è‰²èƒŒæ™¯</a></li>
    </ul>
    <script>
      const path = window.location.pathname;
      history.replaceState({ path: path }, null, path);
      ul.addEventListener("click", (e) => {
        if (e.target.tagName === "A") {
          e.preventDefault();
          const path = e.target.getAttribute("href");
          history.pushState({ path: path }, null, path);
          watchHistory(path);
        }
      });
      function watchHistory() {
        const path = window.location.pathname;
        switch (path) {
          case "/red":
            document.body.style.background = "red";
            break;
          case "/green":
            document.body.style.background = "green";
            break;
          case "/grey":
            document.body.style.background = "grey";
            break;
          default:
            document.body.style.background = "#fff";
        }
      }
      window.addEventListener("popstate", watchHistory, false);
    </script>
  </body>
</html>
```

ç”¨äº† HTML5 çš„å®ç°ï¼Œå•é¡µè·¯ç”±çš„ url å°±ä¸ä¼šå¤šå‡ºä¸€ä¸ª #ï¼Œå˜å¾—æ›´åŠ ç¾è§‚ã€‚

**ä½†å› ä¸ºæ²¡æœ‰ # å·ï¼Œæ‰€ä»¥å½“ç”¨æˆ·åˆ·æ–°é¡µé¢ä¹‹ç±»çš„æ“ä½œæ—¶ï¼Œæµè§ˆå™¨è¿˜æ˜¯ä¼šç»™æœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚**

ä¸ºäº†é¿å…å‡ºç°è¿™ç§æƒ…å†µï¼Œhistory æ¨¡å¼éœ€è¦æœåŠ¡å™¨çš„æ”¯æŒï¼ŒæŠŠæ‰€æœ‰è·¯ç”±éƒ½é‡å®šå‘åˆ°æ ¹é¡µé¢ã€‚

### å¦‚ä½•ç›‘å¬ pushState å’Œ replaceState çš„å˜åŒ–

ç»è¿‡ç†è®ºåŠå®è·µæˆ‘ä»¬çŸ¥é“ replaceState()ï¼ŒpushState() ä¸¤ä¸ª API ä¸ä¼šè§¦å‘ popstate ç›‘å¬äº‹ä»¶ã€‚

æˆ‘ä»¬å¯ä»¥ç”Ÿæˆå…¨æ–°çš„ window ç›‘å¬äº‹ä»¶ç›‘å¬å…¶å˜åŒ–ï¼š

```
function addListen(type) {
  const source = history[type];
  return function () {
    const event = new Event(type);
    event.arguments = arguments;
    window.dispatchEvent(event);
    return source.apply(this, arguments);
  };
}

history.pushState = addListen("pushState");
history.replaceState = addListen("replaceState");

window.addEventListener("replaceState", (e) => {
  console.log("æˆ‘ç›‘å¬äº† replaceState");
});
window.addEventListener("pushState", (e) => {
  console.log("æˆ‘ç›‘å¬äº† pushState");
});
```

# ä¸¤ç§æ¨¡å¼å¯¹æ¯”

1.  æ—  # çš„  history æ¨¡å¼æ›´è‡ªç„¶
2.  history æ¨¡å¼éœ€è¦ IE9 ä»¥ä¸Šï¼Œç›¸å¯¹äº hash æ¨¡å¼çš„ IE8 å…¼å®¹æ€§å·®
3. history æ¨¡å¼éœ€æœåŠ¡å™¨ç«¯é…åˆï¼Œåè¿‡æ¥è¯´ hash æ¨¡å¼ä¸æ”¯æŒæœåŠ¡ç«¯æ¸²æŸ“

# ç»“è¯­

ä»¥ä¸Šå°±æ˜¯å‰ç«¯è·¯ç”±çš„ hash å’Œ history ä¸¤ç§æ¨¡å¼çš„ä¸»è¦åŸç†åŠå®ç°æ€è·¯äº†ï¼Œå¦‚æœä½ è§‰å¾—ä¸é”™ï¼Œåˆ«å¿˜äº†ç‚¹ä¸ªèµğŸ˜„ï¼


---

æœ¬æ–‡å‚è€ƒï¼š

[é¢è¯•å®˜: ä½ äº†è§£å‰ç«¯è·¯ç”±å—?](https://juejin.im/post/5ac61da66fb9a028c71eae1b)

[é˜¿é‡ŒP7ï¼šä½ äº†è§£è·¯ç”±å—ï¼Ÿ](https://juejin.im/post/5e85cb8151882573c66cf63f)

[[å®è·µç³»åˆ—]å‰ç«¯è·¯ç”±](https://github.com/webfansplz/article/issues/1)
